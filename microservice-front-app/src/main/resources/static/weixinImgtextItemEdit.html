
<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width" name="viewport" />
        <meta content="initial-scale=1.0,user-scalable=no,maximum-scale=1" media="(device-height: 568px)" name="viewport">
        <meta content="yes" name="apple-mobile-web-app-capable" />
        <meta content="black" name="apple-mobile-web-app-status-bar-style" />
        <meta content="telephone=no" name="format-detection" />
        <meta http-equiv="Access-Control-Allow-Origin" content="*">
        <title>图文编辑管理修改</title>
    
    <link rel="stylesheet" href="layui/css/layui.css">
<!--     <link rel="stylesheet" href="css/css.css"> -->
    <script src="js/jquery-1.10.1.min.js"></script>
    <script src="js/js.js"></script>
    
    <script src="layer/layer.js"></script>
    <script src="layui/layui.js"></script>
    
    <link rel="stylesheet" href="kindeditor/themes/default/default.css" />
<script charset="utf-8" src="kindeditor/kindeditor-min.js"></script>
<script charset="utf-8" src="kindeditor/lang/zh_CN.js"></script>


<!-- 配置文件 -->
    <script type="text/javascript" src="ueditor/ueditor.config.js"></script>
    <!-- 编辑器源码文件 -->
    <script type="text/javascript" src="ueditor/ueditor.all.js"></script>
    <script type="text/javascript" charset="utf-8" src="ueditor/lang/zh-cn/zh-cn.js"></script>
    
    <link type="text/css" href="ueditor/themes/default/css/ueditor.css" rel="stylesheet" />


</head>

    <body>
    
   <div class="layui-fluid">  
    <div class="layui-row">
    <div class="layui-col-md9" >
           <form id="inputForm" class="layui-form" enctype="multipart/form-data" method="post"  action="" >
             <input name="imgTextId" id="imgTextId"  autocomplete="off" placeholder="请输入" class="layui-input" type="hidden" >
        
         <div class="layui-form-item">
            <div class="layui-input-block">
          <input name="id" id="id"  autocomplete="off" placeholder="请输入" class="layui-input" type="hidden" >
            </div>
         </div>
         <div class="layui-form-item">
            <label class="layui-form-label">标题</label>
            <div class="layui-input-block">
          <input name="title" id="title"  autocomplete="off" placeholder="请输入" class="layui-input" type="text" >
            </div>
         </div>
           <div class="layui-form-item">
            <label class="layui-form-label">文章内容</label>
            <div class="layui-input-block">
            <input name="articleContent" id="articleContent"  type="hidden" >
        <script type="text/pain" id="deitor" name="ceshi"></script>       
        </div>
        </div>
        
         <div class="layui-form-item">
            <label class="layui-form-label">文章分类</label>
            <div class="layui-input-block">
            <select name="categoryId" id="categoryId" lay-filter="aihao">
          </select>
            </div>
         </div>
         <div class="layui-form-item">
            <label class="layui-form-label">原创</label>
            <div class="layui-input-block">
            <input name="yuanchuang" value="1" title="是" checked="checked" type="radio">
          <input name="yuanchuang" value="0" title="否" type="radio">
            </div>
         </div>
        <div class="layui-form-item">
            <label class="layui-form-label">原文链接</label>
            <div class="layui-input-block">
          <input name="originUrl" id="originUrl"  autocomplete="off" placeholder="请输入" class="layui-input" type="text" >
            </div>
         </div>
           <div class="layui-form-item">
            <label class="layui-form-label">留言</label>
            <div class="layui-input-block">
            <input name="seeType" value="1" title="所有人可留言" checked="checked" type="radio">
          <input name="seeType" value="0" title="仅关注后可留言" type="radio">
            </div>
         </div>
     <div class="layui-form-item">
            <label class="layui-form-label">面封图片</label>
            <div class="layui-input-block">
              <input name="headImg" id="headImg"  autocomplete="off"  class="layui-input" type="hidden" >
              <button type="button" class="layui-btn" id="upload">
                    <i class="layui-icon">&#xe67c;</i>选择文件</button>
                    <img id="headImgPic"  style="width:200px; height:100px;" src=""/>
            </div>
         </div>
             
             <div class="layui-form-item">
            <label class="layui-form-label">摘要</label>
            <div class="layui-input-block">
        <textarea name="intro" id="intro" class="layui-textarea"  ></textarea>      
        </div>
        </div>
         <div class="layui-form-item">
            <label class="layui-form-label">序号</label>
            <div class="layui-input-block">
          <input name="sortNo" id="sortNo"  autocomplete="off" placeholder="请输入" lay-verify="required|number"  class="layui-input" type="text" >
            </div>
          </div>
          
           <div class="layui-form-item">
            <div class="layui-input-block">
              <button class="layui-btn" lay-submit="" lay-filter="demo1">立即提交</button>
              <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
            </div>
            
          </form>
          
    </div>
    
    <div class="layui-col-md3" >
         <div class="layui-form-item">
            <div class="layui-input-block">
                <a href="javascript:void(0)" onclick="commonLayerFrame2('选择图片','weixinImgSelectList.html')"> <i class="layui-icon" style="font-size: 80px; ">&#xe64a;</i> 图片  </a>
            </div>
             <div class="layui-input-block">
                  <a href="javascript:void(0)" onclick="commonLayerFrame2('选择视频','weixinVideoSelectList.html')"> <i class="layui-icon" style="font-size: 80px; ">&#xe6ed;</i> 视频  </a>
            </div>
             <div class="layui-input-block">
                  <a href="javascript:void(0)" onclick="commonLayerFrame2('选择音频','weixinAudioSelectList.html')"> <i class="layui-icon" style="font-size: 80px; ">&#xe6fc;</i> 音频  </a>
            </div>
            </div>
          </div>
    </div>
    
  </div>
   
</div>

<script>

var ue ;

layui.use(['form', 'layedit', 'laydate','upload','laytpl'], function(){
    
     var form = layui.form
      ,layer = layui.layer
      ,layedit = layui.layedit
      ,laydate = layui.laydate;

    var postType = "GET";
    var url =ctxAppSec+'/api/WeixinImgtextItem/showInfo/'+getQueryString("id");
    
    //登录
    $.ajax({
        url: url,
        data: {},
        type: postType,
        dataType: "json",
        async:'false',
        success: function(data){
            dataTmp=data;
            $("#title").val(data.weixinImgtextItem.title);
            $("#articleContent").val(data.weixinImgtextItem.articleContent);
           
            
            var yuanchuang =  data.weixinImgtextItem.yuanchuang;
            $(":radio[name='yuanchuang'][value='" + yuanchuang + "']").prop("checked", "checked");
            
            
            $("#originUrl").val(data.weixinImgtextItem.originUrl);
            
            var seeType =  data.weixinImgtextItem.yuanchuang;
            $(":radio[name='seeType'][value='" + seeType + "']").prop("checked", "checked");
            
            $("#headImgPic").attr("src",data.weixinImgtextItem.headImgPic);
            $("#author").val(data.weixinImgtextItem.author);
            
            $("#intro").val(data.weixinImgtextItem.intro);
            
            var categoryId = data.weixinImgtextItem.categoryId;

            initConfigSelect(imgtext_category,"categoryId", categoryId);
            form.render('select'); //刷新select选择框渲染
            $("#categoryId").val(data.weixinImgtextItem.categoryId);
            
            $("#sortNo").val(data.weixinImgtextItem.sortNo);
            
            var articleContent = data.weixinImgtextItem.articleContent;
            
            ue = UE.getEditor('deitor');
            
          //判断ueditor 编辑器是否创建成功
            ue.addListener("ready", function () {
            　　          // editor准备好之后才可以使用
            　                ue.setContent(articleContent);
            });
          
          },
          error: function(data){
              try {
                 layer.msg("请求异常");
                 return false;
              }catch (e) {
                 console.log(e);
              }
          }
     });
    
    
    var upload = layui.upload;

    //执行上传
    var uploadInst = upload.render({
        elem: '#upload' //绑定元素
        ,url: ctxApp+'/file/upload' //上传接口
        ,method: 'POST'
        ,accept: 'file'
        ,before: function(obj){
            layer.load();
        }
        ,done: function(res){//上传完毕回调
            layer.closeAll('loading');
            layer.msg(res.msg);
            var result = ctxApp+"/" +res.imgUrl;
            $("#headImg").val(result);
            $("#headImgPic").attr("src",result);
        }
        ,error: function(){//请求异常回调
            layer.closeAll('loading');
            layer.msg('网络异常，请稍后重试！');
        }
    });
  
  $("#id").val(getQueryString("id"));
  
  //监听提交
  form.on('submit(demo1)', function(data){
  /*   layer.alert(JSON.stringify(data.field), {
      title: '最终的提交信息'
    }) */
    
    var files = data.field;
    var postType ="POST";
    var url =ctxAppSec+'/api/WeixinImgtextItem';
    if(getQueryString("id")!=null){
        postType="PUT";
        url =ctxAppSec+'/api/WeixinImgtextItem/'+getQueryString("id");
    }
    
    var articleContent = ue.getContent();
    $("#articleContent").val(articleContent);
    
    var resObj = $.serializeObject($('form'));
    
 /*    layer.alert(JSON.stringify(resObj), {
        title: '最终的提交信息'
      }) */
      
    //提交
    $.ajax({
        url: url,
        data: resObj,
        type: postType,
        dataType: "json",
        success: function(data){
               layer.closeAll('loading');
                 layer.msg(data.respMsg);
         return true;
          },
          error: function(data){
              try {
                 layer.msg("请求异常");
                 return false;
              }catch (e) {
                 console.log(e);
              }
          }
     });
    
    return false;
  });
  
  
});

function setSelectDataImg(data){
    ue = UE.getEditor('deitor');
   $.each(data, function(index, item){
       var headImg = item.headImg;
       console.log("headImg======="+headImg);
       ue.setContent("<img src="+headImg + "/>",true);
   });
}

//
function setSelectDataVideo(data){
    ue = UE.getEditor('deitor');
   $.each(data, function(index, item){
       var headImg = item.headImg;
       console.log("headImg======="+headImg);
      // TODO: 插入视频信息 ue.setContent("<img src="+headImg + "/>",true);
       
       var content =  '<video src="'+headImg+'"  controls="controls">  </video>'; 
       ue.setContent(content,true);
   });
}

function setSelectDataAudio(data){
    ue = UE.getEditor('deitor');
   $.each(data, function(index, item){
       var headImg = item.headImg;
       console.log("headImg======="+headImg);
       var content =  '<video src="'+headImg+'"  controls="controls">  </video>'; 
       ue.setContent(content,true);
   });
}

</script>

</body>
</html>
